<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Potree-Core Example</title>
	</head>
	<body style="background-color: #000000">
		<script src="lib/threejs/three.min.js"></script>
		<script src="lib/threejs/OrbitControls.js"></script>

		<!--Production-->
		<!--<script src="build/potree.min.js"></script>-->

		<!--Development-->
		<script src="lib/laslaz.js"></script>
		<script src="lib/BinaryHeap.js"></script>
		<script src="source/utils/WorkerPool.js"></script>
		<script src="source/utils/LRU.js"></script>
		<script src="source/utils/XHRFactory.js"></script>
		<script src="source/Potree.js"></script>
		<script src="source/Core.js"></script>
		<script src="source/pointcloud/PointCloudTree.js"></script>
		<script src="source/pointcloud/PointCloudOctree.js"></script>
		<script src="source/pointcloud/geometries/PointCloudOctreeGeometry.js"></script>
		<script src="source/pointcloud/materials/PointCloudMaterial.js"></script>
		<script src="source/loaders/BinaryLoader.js"></script>
		<script src="source/objects/BasicGroup.js"></script>
		<script src="source/objects/Group.js"></script>
		<script src="source/Shaders.js"></script>
		<script>
			document.body.onload = function()
			{
				//three.js
				var scene = new THREE.Scene();
				var camera = new THREE.PerspectiveCamera(60, 1, 0.1, 10000);

				var canvas = document.createElement("canvas");
				canvas.style.position = "absolute";
				canvas.style.top = "0px";
				canvas.style.left = "0px";
				canvas.style.width = "100%";
				canvas.style.height = "100%";
				document.body.appendChild(canvas);

				var renderer = new THREE.WebGLRenderer(
				{
					canvas: canvas,
					alpha: true,
					logarithmicDepthBuffer: false,
					context: null,
					precision: "highp",
					premultipliedAlpha: true,
					antialias: true,
					preserveDrawingBuffer: false,
					powerPreference: "high-performance"
				});

				/*
				var points = new Potree.Group();
				points.setPointBudget(1e10);
				points.material.opacity = 1.0;
				points.material.wireframe = true;
				scene.add(points);
				*/

				var geometry = new THREE.BoxBufferGeometry(5, 1, 5);
				var material = new THREE.MeshBasicMaterial({color: 0x44AA44});
				var cube = new THREE.Mesh(geometry, material);
				cube.position.y = -2;
				scene.add(cube);

				scene.add(new THREE.AmbientLight(0xffffff));

				var controls = new THREE.OrbitControls(camera, canvas);
				camera.position.z = 10;

				var raycaster = new THREE.Raycaster();
				raycaster.params.Points.threshold = 1e-2;
				var normalized = new THREE.Vector2();

				canvas.onmousemove = function(event)
				{
					normalized.set((event.clientX / canvas.width) * 2 - 1, -(event.clientY / canvas.height) * 2 + 1);
					raycaster.setFromCamera(normalized, camera);
				}

				canvas.ondblclick = function(event)
				{
					var intesects = raycaster.intersectObject(scene, true);
					
					console.log(intesects);
					
					if(intesects.length > 0)
					{
						var geometry = new THREE.SphereBufferGeometry(0.1, 32, 32);
						var material = new THREE.MeshBasicMaterial({color: 0xAA4444});
						var sphere = new THREE.Mesh(geometry, material);
						sphere.position.copy(intesects[0].point);
						scene.add(sphere);
					}
				}

				/*
				var url = "data/lion_takanawa_laz/cloud.js";

				Potree.loadPointCloud(url, name, function(e)
				{
					var pointcloud = e.pointcloud;
					pointcloud.position.set(-2, -3, 0.4);

					var material = pointcloud.material;
					material.size = 2;
					material.pointColorType = Potree.PointColorType.RGB; //RGB | DEPTH | HEIGHT | POINT_INDEX | LOD | CLASSIFICATION
					material.pointSizeType = Potree.PointSizeType.ADAPTIVE; //ADAPTIVE | FIXED
					material.shape = Potree.PointShape.CIRCLE; //CIRCLE | SQUARE

					points.add(pointcloud);
				});
				*/

				//for(var k = 5; k >= 0; k--)
				for(var k = 0; k < 6; k++)
				{
					var url = "data/eqs_" + k + "/cloud.js";

					Potree.loadPointCloud(url, "eqs_" + k, function(e)
					{
						var pointcloud = e.pointcloud;

						var points = new Potree.Group();
						points.setPointBudget(1e10);
						points.material.opacity = 1.0;
						points.material.wireframe = true;
						points.name = pointcloud.name;
						scene.add(points);
						
						var material = pointcloud.material;
						material.size = 4;
						material.pointColorType = Potree.PointColorType.RGB; //RGB | DEPTH | HEIGHT | POINT_INDEX | LOD | CLASSIFICATION
						material.pointSizeType = Potree.PointSizeType.ADAPTIVE; //ADAPTIVE | FIXED
						material.shape = Potree.PointShape.CIRCLE; //CIRCLE | SQUARE
						points.add(pointcloud);
					});
				}

				function loop()
				{
					cube.rotation.y += 0.01;

					controls.update();
					renderer.render(scene, camera);

					requestAnimationFrame(loop);
				};
				loop();

				document.body.onresize = function()
				{
					var width = window.innerWidth;
					var height = window.innerHeight;
					
					renderer.setSize(width, height);
					camera.aspect = width / height;
					camera.updateProjectionMatrix();
				}
				document.body.onresize();
			};
		</script>
	</body>
</html>