<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
	</head>
	<body>
		<script src="libs/threejs/three.min.js"></script>
		<script src="libs/threejs/OrbitControls.js"></script>

		<script src="libs/jquery-3.1.1.min.js"></script>
		<script src="libs/BinaryHeap.js"></script>
		<script src="libs/proj4.js"></script>

		<script src="libs/potree/potree.js"></script>
		
		<script src="source/PotreeRenderer.js"></script>
		<script src="source/PotreeScene.js"></script>
		<script src="source/PotreeViewer.js"></script>
		<script>
			//three.js
			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera(60, 1, 0.1, 10000);

			var canvas = document.createElement("canvas");
			canvas.style.position = "absolute";
			canvas.style.top = "0px";
			canvas.style.left = "0px";
			canvas.style.width = "100%";
			canvas.style.height = "100%";
			document.body.appendChild(canvas);

			var renderer = new THREE.WebGLRenderer({canvas:canvas});
			var gl = renderer.context;
			gl.getExtension("EXT_frag_depth");
			gl.getExtension("WEBGL_depth_texture");
			
			var extVAO = gl.getExtension("OES_vertex_array_object");
			gl.createVertexArray = extVAO.createVertexArrayOES.bind(extVAO);
			gl.bindVertexArray = extVAO.bindVertexArrayOES.bind(extVAO);

			var geometry = new THREE.BoxGeometry(1, 1, 1);
			var material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
			var cube = new THREE.Mesh(geometry, material);
			scene.add(cube);

			var controls = new THREE.OrbitControls(camera, canvas);
			camera.position.z = 10;

			//Potree
			var viewer = new PotreeViewer(renderer);
			var clock = new THREE.Clock();

			loadCloud("galp");
			loadCloud("leixoes", -59, -40, -18, 0.2, 0.2, 0.2);

			function loadCloud(name, pX, pY, pZ, sX, sY, sZ)
			{
				Potree.loadPointCloud("data/models/" + name + "/cloud.js", name, function(e)
				{
					var pointcloud = e.pointcloud;

					if(pX !== undefined) pointcloud.position.set(pX, pY, pZ);
					if(sX !== undefined) pointcloud.scale.set(sX, sY, sZ);

					var material = pointcloud.material;
					material.size = 1;
					material.pointColorType = Potree.PointColorType.RGB;
					material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
					material.shape = Potree.PointShape.SQUARE;

					console.log(pointcloud);
					viewer.scene.addPointCloud(pointcloud);
				});
			}

			function loop()
			{	
				var delta = clock.getDelta();

				//three.js
				controls.update();
				renderer.render(scene, camera);

				//Potree
				viewer.update(delta, camera);
				viewer.render(camera);

				requestAnimationFrame(loop);
			};
			loop();

			document.body.onresize = function()
			{
				var width = window.innerWidth;
				var height = window.innerHeight;

				//three.js
				renderer.setSize(width, height);
				camera.aspect = width / height;
				camera.updateProjectionMatrix();

				//Potree
				viewer.resize(width, height);
			}
			document.body.onresize();
		</script>
	</body>
</html>